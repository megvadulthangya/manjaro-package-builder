name: MPB - with diagnostic

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'  # Daily at 4 AM UTC

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    env:
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      REPO_SERVER_URL: ${{ secrets.REPO_SERVER_URL }}
      REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
      REPO_NAME: ${{ secrets.REPO_NAME || 'manjaro-awesome' }}
      CI_PUSH_SSH_KEY: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout Code with Full History
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fix PKGBUILD Epoch Issues
        run: |
          echo "=== Fixing PKGBUILD epoch issues ==="
          
          # Fix awesome-freedesktop-git PKGBUILD (remove epoch)
          if [ -f "awesome-freedesktop-git/PKGBUILD" ]; then
            echo "Fixing awesome-freedesktop-git/PKGBUILD..."
            sed -i '/^epoch=/d' awesome-freedesktop-git/PKGBUILD
            # Increment pkgrel to ensure new version
            current_pkgrel=$(grep -oP '^pkgrel=\K\d+' awesome-freedesktop-git/PKGBUILD)
            if [ -n "$current_pkgrel" ]; then
              new_pkgrel=$((current_pkgrel + 1))
              sed -i "s/^pkgrel=.*/pkgrel=$new_pkgrel/" awesome-freedesktop-git/PKGBUILD
              echo "Updated pkgrel from $current_pkgrel to $new_pkgrel"
            fi
          fi
          
          # Check for other packages with epoch
          echo "Checking for other packages with epoch in PKGBUILD..."
          find . -name "PKGBUILD" -type f -exec grep -l "^epoch=" {} \;
          
          echo "‚úÖ PKGBUILD fixes complete"

      - name: Prepare Environment
        run: |
          echo "=== Starting Environment Preparation ==="
          echo "Repository: $REPO_NAME"
          echo "Server URL: $REPO_SERVER_URL"
          
          # Skip key signing issues
          echo "Setting up pacman without key signing..."
          sed -i 's/^SigLevel.*/SigLevel = Never/g' /etc/pacman.conf
          
          # UPDATE SYSTEM WITHOUT OUR REPOSITORY
          echo "Updating system (ignoring our repository for now)..."
          
          # Save current pacman.conf
          cp /etc/pacman.conf /etc/pacman.conf.backup
          
          # Temporarily remove our repository section if it exists
          if grep -q "^\[$REPO_NAME\]" /etc/pacman.conf; then
            echo "Temporarily removing $REPO_NAME repository section..."
            sed -i "/^\[$REPO_NAME\]/,/^\[/d" /etc/pacman.conf
          fi
          
          # Update system with minimal packages first
          pacman -Syu --noconfirm --needed \
            git base-devel sudo \
            python python-pip \
            python-requests python-gitpython python-yaml python-setuptools \
            pacman-contrib \
            curl wget ca-certificates \
            openssh rsync \
            netcat iproute2 \
            jq  # Added for JSON parsing in diagnostics
            
          # Restore pacman.conf
          mv /etc/pacman.conf.backup /etc/pacman.conf
          
          # Create builder user
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # Set ownership
          chown -R builder:builder "$(pwd)"
          
          # Create build directories with correct permissions
          mkdir -p "$(pwd)/build_aur"
          chown -R builder:builder "$(pwd)/build_aur"
          mkdir -p "$(pwd)/built_packages"
          chown -R builder:builder "$(pwd)/built_packages"
          
          # Optimize makepkg
          sed -i '/^OPTIONS=/ s/ debug/ !debug/' /etc/makepkg.conf
          sed -i "s/^COMPRESSZST=.*/COMPRESSZST=(zstd -c -T0 --ultra -20 -)/" /etc/makepkg.conf
          
          echo "‚úÖ Environment preparation complete"

      - name: Setup SSH for VPS
        run: |
          echo "=== Setting up SSH for VPS connection ==="
          
          # Create SSH directory for builder user
          mkdir -p /home/builder/.ssh
          chmod 700 /home/builder/.ssh
          
          # Write SSH key for VPS
          echo "Writing SSH key for VPS..."
          if echo "$VPS_SSH_KEY" | base64 -d >/dev/null 2>&1; then
            echo "üîë Key appears to be base64 encoded, decoding..."
            echo "$VPS_SSH_KEY" | base64 -d > /home/builder/.ssh/id_ed25519
          else
            echo "üîë Key is plain text, writing as-is..."
            echo "$VPS_SSH_KEY" > /home/builder/.ssh/id_ed25519
          fi
          
          chmod 600 /home/builder/.ssh/id_ed25519
          
          # Also add to known_hosts
          ssh-keyscan -H "$VPS_HOST" >> /home/builder/.ssh/known_hosts 2>/dev/null || true
          
          chown -R builder:builder /home/builder/.ssh
          
          echo "‚úÖ SSH setup for VPS complete"

      - name: Configure Pacman Repository
        run: |
          echo "=== Configuring Pacman Repository ==="
          echo "Repository: $REPO_NAME"
          echo "Server URL: $REPO_SERVER_URL"
          
          if [ -z "$REPO_NAME" ] || [ -z "$REPO_SERVER_URL" ]; then
            echo "‚ùå ERROR: REPO_NAME or REPO_SERVER_URL is empty!"
            exit 1
          fi
          
          # Check if repository already exists in pacman.conf
          if grep -q "^\[$REPO_NAME\]" /etc/pacman.conf; then
            echo "‚úÖ Repository '$REPO_NAME' already exists in pacman.conf"
            echo "Updating server URL if needed..."
            
            sed -i "/\[$REPO_NAME\]/,/^\[/ s|^Server = .*|Server = $REPO_SERVER_URL|" /etc/pacman.conf
          else
            echo "‚ûï Adding repository '$REPO_NAME' to pacman.conf"
            
            TEMP_FILE=$(mktemp)
            echo "" >> "$TEMP_FILE"
            echo "# Custom repository: $REPO_NAME" >> "$TEMP_FILE"
            echo "# Repository will be dynamically enabled/disabled by builder.py" >> "$TEMP_FILE"
            echo "[$REPO_NAME]" >> "$TEMP_FILE"
            echo "Server = $REPO_SERVER_URL" >> "$TEMP_FILE"
            echo "SigLevel = Optional TrustAll" >> "$TEMP_FILE"
            
            cat "$TEMP_FILE" >> /etc/pacman.conf
            rm -f "$TEMP_FILE"
          fi
          
          echo "=== Pacman.conf repository section ==="
          grep -A 2 "^\[$REPO_NAME\]" /etc/pacman.conf || echo "‚ùå Repository not found in pacman.conf"
          
          echo ""
          echo "‚úÖ Pacman repository configuration complete"
          echo "Note: Repository will be enabled/disabled dynamically by builder.py"

      - name: Rsync Connection Test
        run: |
          echo "=== Rsync Connection Test ==="
          
          # Test basic connectivity
          echo "1. Testing internet connectivity..."
          if ping -c 2 8.8.8.8 >/dev/null 2>&1; then
            echo "‚úÖ Internet connectivity OK"
          else
            echo "‚ö†Ô∏è No internet connectivity via IP - may be a container issue"
          fi
          
          # Test VPS connectivity
          echo ""
          echo "2. Testing VPS connectivity..."
          if timeout 5 nc -z -w 2 "$VPS_HOST" 22; then
            echo "‚úÖ VPS port 22 is accessible"
          else
            echo "‚ùå Cannot reach VPS on port 22"
          fi
          
          # Test SSH as builder user using the EXACT same options builder.py will use
          echo ""
          echo "3. Testing SSH connection as builder user..."
          SSH_OPTIONS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=60 -o ServerAliveInterval=30 -o ServerAliveCountMax=5 -o TCPKeepAlive=yes -o BatchMode=yes -o LogLevel=ERROR"
          
          if su builder -c "timeout 20 ssh $SSH_OPTIONS -i /home/builder/.ssh/id_ed25519 $VPS_USER@$VPS_HOST 'echo SSH_TEST_SUCCESS'" 2>/dev/null; then
            echo "‚úÖ SSH connection to VPS successful"
          else
            echo "‚ùå SSH connection to VPS failed"
          fi
          
          echo "‚úÖ Rsync tests complete"

      - name: Install Build Dependencies
        run: |
          echo "=== Installing Build Dependencies ==="
          
          # Save current pacman.conf
          cp /etc/pacman.conf /etc/pacman.conf.backup
          
          # Temporarily comment out our repository to avoid 404 errors
          echo "Temporarily commenting out $REPO_NAME repository for dependency installation..."
          sed -i "/^\[$REPO_NAME\]/,/^\[/ s/^/#/" /etc/pacman.conf
          
          # Install remaining build tools
          echo "Installing build tools..."
          pacman -S --needed --noconfirm \
            appstream appstream-glib \
            meson ninja cmake \
            gtk-doc docbook-xsl libxslt \
            gobject-introspection \
            autoconf automake libtool pkg-config \
            patch make gcc binutils \
            file which tar gzip bzip2 xz zstd \
            unzip p7zip gnupg \
            dbus polkit \
            systemd systemd-sysvcompat \
            arch-install-scripts \
            ldc po4a dconf  # tilix-git specific dependencies
            
          # Restore pacman.conf
          mv /etc/pacman.conf.backup /etc/pacman.conf
          
          # Install yay for AUR dependencies
          echo "=== Installing yay ==="
          chmod 777 /tmp
          cd /tmp
          sudo -u builder git clone https://aur.archlinux.org/yay-bin.git
          cd yay-bin
          sudo -u builder makepkg -si --noconfirm
          cd /
          rm -rf /tmp/yay-bin
          
          # Configure yay to use --aur flag by default
          echo "Configuring yay..."
          sudo -u builder yay --aur --save
          
          echo "‚úÖ Build dependencies installed"

      - name: H√°l√≥zati diagnosztika
        run: |
          echo "=== H√ÅL√ìZATI DIAGNOSZTIKA ==="
          
          echo "1. Aktu√°lis IP c√≠mek √©s inform√°ci√≥k:"
          echo "   - Publikus IP (fail2ban-hoz):"
          PUBLIC_IP1=$(curl -s https://api.ipify.org)
          PUBLIC_IP2=$(curl -s https://checkip.amazonaws.com | tr -d '\n')
          echo "     IP 1: $PUBLIC_IP1"
          echo "     IP 2: $PUBLIC_IP2"
          
          echo ""
          echo "   - R√©szletes IP inform√°ci√≥k:"
          curl -s https://ipinfo.io/json | jq -r '"     IP: " + .ip, "     V√°ros: " + .city, "     R√©gi√≥: " + .region, "     Orsz√°g: " + .country, "     Szolg√°ltat√≥: " + .org' || echo "     Nem siker√ºlt lek√©rni az IP inf√≥kat"
          
          echo ""
          echo "2. Kimen≈ë interface inform√°ci√≥k:"
          ip route show default 2>/dev/null | head -1 || echo "     Alap√©rtelmezett route nem tal√°lhat√≥"
          echo ""
          echo "   - Aktu√°lis IP c√≠mek (√∂sszes interface):"
          ip addr show 2>/dev/null | grep 'inet ' | awk '{print "     " $2 " on " $NF}' || echo "     Nem siker√ºlt lek√©rni az interface-eket"
          
          echo ""
          echo "3. DNS konfigur√°ci√≥:"
          cat /etc/resolv.conf 2>/dev/null | grep -v '^#' | grep -v '^$' | while read line; do echo "   $line"; done || echo "   Nem siker√ºlt lek√©rni a DNS konfigur√°ci√≥t"
          
          echo ""
          echo "4. GitHub Actions specifikus inform√°ci√≥k:"
          echo "     GITHUB_ACTIONS: $GITHUB_ACTIONS"
          echo "     GITHUB_RUN_ID: $GITHUB_RUN_ID"
          echo "     RUNNER_OS: $RUNNER_OS"
          
          echo ""
          echo "5. Let√∂lt≈ë eszk√∂z√∂k:"
          command -v curl && curl --version | head -1 || echo "     curl nem tal√°lhat√≥"
          command -v wget && wget --version | head -1 || echo "     wget nem tal√°lhat√≥"
          command -v rsync && rsync --version | head -1 || echo "     rsync nem tal√°lhat√≥"
          
          echo ""
          echo "6. El√©rhet≈ës√©g tesztek:"
          echo "   - GitHub:"
          timeout 5 curl -s -I https://github.com 2>/dev/null | head -1 || echo "     Nem el√©rhet≈ë"
          echo "   - AUR:"
          timeout 5 curl -s -I https://aur.archlinux.org 2>/dev/null | head -1 || echo "     Nem el√©rhet≈ë"
          echo "   - C√©l VPS ($VPS_HOST):"
          timeout 5 ping -c 2 "$VPS_HOST" 2>/dev/null | grep "bytes from" || echo "     Ping nem el√©rhet≈ë"
          
          echo ""
          echo "7. H√°l√≥zati kapcsolatok (aktu√°lis):"
          ss -tunp 2>/dev/null | grep ESTAB | head -5 | while read line; do echo "   $line"; done || echo "   Nem siker√ºlt lek√©rni a kapcsolatokat"
          
          echo ""
          echo "8. IP c√≠m lista fail2ban-hoz:"
          echo "   üîç FAIL2BAN WHITELIST PARANCSOK:"
          echo "   sudo fail2ban-client set sshd addignoreip $PUBLIC_IP1"
          echo "   # vagy m√°s jail neve:"
          echo "   sudo fail2ban-client set apache-auth addignoreip $PUBLIC_IP1"
          echo "   # Vagy iptables:"
          echo "   sudo iptables -A INPUT -s $PUBLIC_IP1 -j ACCEPT"
          
          echo ""
          echo "9. VPS teszt kapcsolat:"
          SSH_OPTIONS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10"
          if su builder -c "timeout 15 ssh $SSH_OPTIONS -i /home/builder/.ssh/id_ed25519 $VPS_USER@$VPS_HOST 'echo VPS_KAPCSOLAT_OK'" 2>/dev/null; then
            echo "   ‚úÖ VPS SSH kapcsolat m≈±k√∂dik"
          else
            echo "   ‚ùå VPS SSH kapcsolat NEM m≈±k√∂dik"
            echo "   Ellen≈ërizd a fail2ban logokat:"
            echo "   sudo tail -f /var/log/fail2ban.log"
          fi
          
          echo ""
          echo "10. Csomag ellen≈ërz√©sek sz√°ma (k√∂zel√≠t≈ë):"
          echo "    Ez a sz√°m okozhat fail2ban probl√©m√°t, ha t√∫l sok k√©r√©st ind√≠t:"
          if [ -d "." ]; then
            PKG_COUNT=$(find . -name "PKGBUILD" -type f | wc -l)
            echo "    PKGBUILD f√°jlok sz√°ma: $PKG_COUNT"
            echo "    ~ Ellen≈ërz√©sek sz√°ma: $((PKG_COUNT * 2)) (build el≈ëtti √©s ut√°ni ellen≈ërz√©sek)"
          fi
          
          echo ""
          echo "=== DIAGNOSZTIKA V√âGE ==="
          echo ""
          echo "‚ö†Ô∏è  JEGYZET: Ha fail2ban blokkol, pr√≥b√°ld ki ezt a VPS-en:"
          echo "    sudo fail2ban-client unban $PUBLIC_IP1"
          echo "    sudo fail2ban-client set sshd addignoreip $PUBLIC_IP1"

      - name: Run Builder
        run: |
          echo "=== Starting Builder ==="
          
          chmod +x .github/scripts/builder.py
          
          echo "Current directory: $(pwd)"
          
          # Test SSH connection one more time with identical options to builder.py
          echo "=== Final SSH Test ==="
          SSH_OPTIONS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=60 -o ServerAliveInterval=30 -o ServerAliveCountMax=5 -o TCPKeepAlive=yes -o BatchMode=yes -o LogLevel=ERROR"
          
          if su builder -c "timeout 25 ssh $SSH_OPTIONS -i /home/builder/.ssh/id_ed25519 $VPS_USER@$VPS_HOST 'echo READY'" 2>/dev/null; then
            echo "‚úÖ SSH connection confirmed"
          else
            echo "‚ö†Ô∏è SSH connection may have issues"
          fi
          
          echo ""
          echo "=== Repository Status ==="
          # Check if repository exists but don't fail if it doesn't
          if curl -s -I "$REPO_SERVER_URL" 2>/dev/null | head -n1 | grep -q "200\|404"; then
            echo "‚úÖ Repository server is accessible"
          else
            echo "‚ö†Ô∏è Repository server is NOT accessible (may be empty or not exist)"
          fi
          
          echo ""
          echo "=== Running Builder Script ==="
          
          # Set environment for builder
          export HOME=/home/builder
          export VPS_USER="$VPS_USER"
          export VPS_HOST="$VPS_HOST"
          export VPS_SSH_KEY="$VPS_SSH_KEY"
          export REPO_SERVER_URL="$REPO_SERVER_URL"
          export REMOTE_DIR="$REMOTE_DIR"
          export REPO_NAME="$REPO_NAME"
          export CI_PUSH_SSH_KEY="$CI_PUSH_SSH_KEY"
          
          # Run as builder user
          su builder -c "cd '$PWD' && python3 .github/scripts/builder.py 2>&1" | tee build_output.log
          
          BUILD_STATUS=$?
          echo ""
          echo "=== Build finished with exit code: $BUILD_STATUS ==="
          
          if [ -f "builder.log" ]; then
            echo "=== Last 20 lines of builder.log ==="
            tail -20 builder.log
          fi
          
          exit $BUILD_STATUS

      - name: Sanitize Artifact Filenames
        if: always()
        run: |
          echo "=== Sanitizing artifact filenames ==="
          
          # Create a sanitized copy of built packages
          if [ -d "built_packages" ] && [ "$(ls -A built_packages 2>/dev/null)" ]; then
            echo "Creating sanitized artifact directory..."
            mkdir -p artifact_packages
            
            for file in built_packages/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                # Replace invalid characters
                sanitized_name=$(echo "$filename" | sed 's/:/_/g' | sed 's/[<>|*?"\r\n]//g')
                echo "Copying: $filename -> $sanitized_name"
                cp "$file" "artifact_packages/$sanitized_name"
              fi
            done
            
            echo "‚úÖ Artifact filenames sanitized"
          else
            echo "‚ö†Ô∏è No built packages found to sanitize"
          fi

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-results-$(date +%s)
          path: |
            builder.log
            build_output.log
            artifact_packages/
          retention-days: 7